apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: state-store-composition
  labels:
    crossplane.io/xrd: statestores.shoulders.io
spec:
  compositeTypeRef:
    apiVersion: shoulders.io/v1alpha1
    kind: StateStore
  mode: Pipeline
  pipeline:
    - step: go-templating
      functionRef:
        name: function-go-templating
      input:
        apiVersion: gotemplating.fn.crossplane.io/v1beta1
        kind: GoTemplate
        source: Inline
        inline:
          template: |
            {{ if .observed.composite.resource.spec.postgresql.enabled }}
            ---
            apiVersion: postgresql.cnpg.io/v1
            kind: Cluster
            metadata:
              annotations:
                gotemplating.fn.crossplane.io/composition-resource-name: "postgres-cluster"
              name: {{ .observed.composite.resource.metadata.name | quote }}
              namespace: {{ .observed.composite.resource.metadata.namespace | quote }}
            spec:
              instances: 2
              bootstrap:
                initdb:
                  database: app
                  owner: app
                  secret:
                    name: app-secret
                  postInitSQL:
                    {{- range .observed.composite.resource.spec.postgresql.databases }}
                    - {{ printf "CREATE DATABASE %q;" . | quote }}
                    - {{ printf "GRANT ALL PRIVILEGES ON DATABASE %q TO app;" . | quote }}
                    {{- end }}
              storage:
                size: {{ .observed.composite.resource.spec.postgresql.storage | default "1Gi" | quote }}
            ---
            apiVersion: v1
            kind: Secret
            metadata:
              annotations:
                gotemplating.fn.crossplane.io/composition-resource-name: "app-secret"
              name: "app-secret"
              namespace: {{ .observed.composite.resource.metadata.namespace | quote }}
            type: Opaque
            data:
              username: YXBw
              password: cGFzc3dvcmQ=
            {{ end }}

            {{ if .observed.composite.resource.spec.redis.enabled }}
            ---
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              annotations:
                gotemplating.fn.crossplane.io/composition-resource-name: "redis-deployment"
              name: {{ printf "%s-redis" .observed.composite.resource.metadata.name | quote }}
              namespace: {{ .observed.composite.resource.metadata.namespace | quote }}
              labels:
                app: redis
            spec:
              replicas: {{ .observed.composite.resource.spec.redis.replicas | default 1 }}
              selector:
                matchLabels:
                  app: redis
              template:
                metadata:
                  labels:
                    app: redis
                spec:
                  containers:
                    - name: redis
                      image: redis:8.2-alpine
                      ports:
                        - containerPort: 6379
            ---
            apiVersion: v1
            kind: Service
            metadata:
              annotations:
                gotemplating.fn.crossplane.io/composition-resource-name: "redis-service"
              name: {{ printf "%s-redis" .observed.composite.resource.metadata.name | quote }}
              namespace: {{ .observed.composite.resource.metadata.namespace | quote }}
              labels:
                app: redis
            spec:
              selector:
                app: redis
              ports:
                - port: 6379
                  targetPort: 6379
            {{ end }}

    - step: auto-ready
      functionRef:
        name: function-auto-ready
