name: mcp-server-release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "shoulders-bot"
          git config user.email "shoulders-bot@users.noreply.github.com"

      - name: Split subtree
        run: git subtree split --prefix shoulders-mcp-server -b mcp-server-split

      - name: Push to standalone repo
        env:
          TARGET_REPO: ${{ secrets.MCP_SERVER_REPO }}
          TARGET_TOKEN: ${{ secrets.MCP_SERVER_REPO_TOKEN }}
        run: |
          if [ -z "$TARGET_REPO" ] || [ -z "$TARGET_TOKEN" ]; then
            echo "Missing MCP_SERVER_REPO or MCP_SERVER_REPO_TOKEN secret."
            exit 1
          fi
          git remote add mcp-server "https://x-access-token:${TARGET_TOKEN}@github.com/${TARGET_REPO}.git"
          git push mcp-server mcp-server-split:main --force

      - name: Push tag to standalone repo
        if: startsWith(github.ref, 'refs/tags/')
        env:
          TARGET_REPO: ${{ secrets.MCP_SERVER_REPO }}
          TARGET_TOKEN: ${{ secrets.MCP_SERVER_REPO_TOKEN }}
        run: |
          git remote add mcp-server "https://x-access-token:${TARGET_TOKEN}@github.com/${TARGET_REPO}.git" || true
          git push mcp-server "${GITHUB_REF_NAME}"
