name: release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: shoulders-cli/go.mod

      - name: GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean --config .goreleaser.yml
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

  plugin-release:
    runs-on: ubuntu-latest
    needs: goreleaser
    defaults:
      run:
        working-directory: shoulders-portal-plugin
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: shoulders-portal-plugin/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Align plugin version with tag
        run: npm version "${GITHUB_REF_NAME#v}" --no-git-tag-version

      - name: Build plugin
        run: npm run build

      - name: Package plugin
        run: npm run package

      - name: Compute checksum
        run: sha256sum shoulders-portal-plugin-*.tar.gz > shoulders-portal-plugin-checksums.txt

      - name: Upload plugin assets to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            shoulders-portal-plugin/shoulders-portal-plugin-*.tar.gz
            shoulders-portal-plugin/shoulders-portal-plugin-checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

  artifacthub-metadata:
    runs-on: ubuntu-latest
    needs: plugin-release
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Generate Artifact Hub metadata for release
        env:
          TAG: ${{ github.ref_name }}
          REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail

          VERSION="${TAG#v}"
          PACKAGE_NAME="shoulders-portal"
          PKG_DIR="artifacthub/headlamp-plugins/${PACKAGE_NAME}/${VERSION}"
          ARCHIVE_NAME="shoulders-portal-plugin-${VERSION}.tar.gz"
          ARCHIVE_URL="https://github.com/${REPOSITORY}/releases/download/${TAG}/${ARCHIVE_NAME}"

          mkdir -p "${PKG_DIR}"

          curl -fsSL "${ARCHIVE_URL}" -o /tmp/${ARCHIVE_NAME}
          CHECKSUM="sha256:$(sha256sum /tmp/${ARCHIVE_NAME} | awk '{print $1}')"
          CREATED_AT="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          cp shoulders-portal-plugin/README.md "${PKG_DIR}/README.md"

          cat > "${PKG_DIR}/artifacthub-pkg.yml" <<EOF
          version: ${VERSION}
          name: shoulders-portal
          displayName: Shoulders Portal
          createdAt: ${CREATED_AT}
          description: Shoulders portal plugin for Headlamp.
          homeURL: https://github.com/${REPOSITORY}
          keywords:
            - headlamp
            - kubernetes
            - crossplane
          links:
            - name: Source
              url: https://github.com/${REPOSITORY}
            - name: Release ${TAG}
              url: https://github.com/${REPOSITORY}/releases/tag/${TAG}
          annotations:
            headlamp/plugin/archive-url: "${ARCHIVE_URL}"
            headlamp/plugin/archive-checksum: "${CHECKSUM}"
            headlamp/plugin/distro-compat: "in-cluster,web"
          EOF

      - name: Commit and push metadata updates
        env:
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          if [[ -z "$(git status --porcelain artifacthub/headlamp-plugins)" ]]; then
            echo "No metadata changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add artifacthub/headlamp-plugins
          git commit -m "chore(artifacthub): publish shoulders-portal ${TAG#v}"
          git push origin HEAD:main

  bump-headlamp-plugin-version:
    runs-on: ubuntu-latest
    needs: artifacthub-metadata
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Update plugin version in HelmRelease
        env:
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          VERSION="${TAG#v}"

          ruby - <<'RUBY'
          file = '2-addons/manifests/helm-releases/headlamp.yaml'
          version = ENV.fetch('VERSION')
          text = File.read(file)

          pattern = /(plugins:\n(?:\s*#.*\n)*\s*-\s*name:\s*shoulders-portal\n\s*source:\s*.*\n\s*version:\s*)([^\n]+)/
          updated = text.sub(pattern) { "#{$1}#{version}" }

          if updated == text
            warn 'No shoulders-portal plugin version entry found to update.'
            exit 1
          end

          File.write(file, updated)
          RUBY

      - name: Create pull request for version bump
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          commit-message: "chore(headlamp): bump shoulders-portal plugin to ${{ github.ref_name }}"
          branch: "automation/headlamp-plugin-${{ github.ref_name }}"
          delete-branch: true
          title: "chore(headlamp): bump shoulders-portal plugin to ${{ github.ref_name }}"
          body: |
            Automated update created by the release workflow.

            Changes:
            - Bumps `pluginsManager.configContent.plugins[name=shoulders-portal].version`
              in `2-addons/manifests/helm-releases/headlamp.yaml`
            - Target version: `${{ github.ref_name }}`
